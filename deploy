#!/usr/bin/env bash
set -eux

DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )

HOSTNAME="$1"
shift
CONFIG="$1"
shift

eval "$(ssh-agent)"
ssh-add "$CONFIG/ssh_key"

RESULT="$(nix-build --no-out-link -A completeServer.aws.system --argstr hostName "$HOSTNAME" "$@")"

nix-copy-closure -v --to root@"$HOSTNAME" --gzip "$RESULT"

# Work around https://www.pivotaltracker.com/story/show/109156520
find -L "$(nix-build --no-out-link)" -exec readlink -f '{}' \; | sed -n 's_\(^/nix/store/[^/][^/]*\).*$_\1_p' | sort | uniq | xargs --verbose nix-copy-closure -v --to root@"$HOSTNAME" --gzip

"$DIR/deploy-config" "ssh" root@"$HOSTNAME" "$CONFIG"

ssh root@"$HOSTNAME" bash -x <<EOF
nix-env -p /nix/var/nix/profiles/system --set "$RESULT"
/nix/var/nix/profiles/system/bin/switch-to-configuration switch
EOF
